---
- name: Define LDAP server organization domain
  ansible.builtin.debconf:
    name: slapd
    question: "slapd/domain"
    value: "{{ ldap_domain }}"
    vtype: string

- name: Define LDAP server administration password
  ansible.builtin.debconf:
    name: slapd
    question: "{{ item }}"
    value: "{{ ldap_admin_password }}"
    vtype: password
  loop:
  - slapd/password1
  - slapd/password2

- name: Install LDAP packages
  ansible.builtin.package:
    name: "{{ ldap_packages }}"
    state: latest
  register: ldap_packages_installation

- name: Generate bootstrap LDIF
  ansible.builtin.template:
    src: bootstrap.ldif.j2
    dest: "{{ ldap_ldif_path }}"
    owner: "{{ ldap_system_user }}"
    group: "{{ ldap_system_group }}"
    mode: '0600'
  when: ldap_packages_installation is changed

- name: Insert boostrap LDIF in LDAP directory
  become: true
  become_method: su
  # shell of ldap system user is disabled, flag is used to force real shell
  become_flags: '-s /bin/sh'
  become_user: "{{ ldap_system_user }}"
  ansible.builtin.command:
    cmd: "/usr/sbin/slapadd -v -l {{ ldap_ldif_path }}"
  when: ldap_packages_installation is changed
